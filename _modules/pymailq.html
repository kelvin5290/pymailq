
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pymailq &#8212; PyMailq 0.8.0
 documentation</title>
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.8.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
  </head>
  <body>
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>PyMailq 0.8.0
 documentation</span></a></h1>
        <h2 class="heading"><span>pymailq</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>
      <div class="content">
        
        
  <h1>Source code for pymailq</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1">#    Postfix queue control python tool (pymailq)</span>
<span class="c1">#</span>
<span class="c1">#    Copyright (C) 2014 Denis Pompilio (jawa) &lt;denis.pompilio@gmail.com&gt;</span>
<span class="c1">#</span>
<span class="c1">#    This file is part of pymailq</span>
<span class="c1">#</span>
<span class="c1">#    This program is free software; you can redistribute it and/or</span>
<span class="c1">#    modify it under the terms of the GNU General Public License</span>
<span class="c1">#    as published by the Free Software Foundation; either version 2</span>
<span class="c1">#    of the License, or (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#    GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">configparser</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">ConfigParser</span> <span class="k">as</span> <span class="nn">configparser</span>

<span class="c1">#: Boolean to control activation of the :func:`debug` decorator.</span>
<span class="n">DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">#: Current version of the package as :class:`str`.</span>
<span class="n">VERSION</span> <span class="o">=</span> <span class="s2">&quot;0.8.0&quot;</span>

<span class="c1">#: Module configuration as :class:`dict`.</span>
<span class="n">CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;core&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;postfix_spool&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/spool/postfix&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;commands&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;use_sudo&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s2">&quot;list_queue&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mailq&quot;</span><span class="p">],</span>
        <span class="s2">&quot;cat_message&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;postcat&quot;</span><span class="p">,</span> <span class="s2">&quot;-qv&quot;</span><span class="p">],</span>
        <span class="s2">&quot;hold_message&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;postsuper&quot;</span><span class="p">,</span> <span class="s2">&quot;-h&quot;</span><span class="p">],</span>
        <span class="s2">&quot;release_message&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;postsuper&quot;</span><span class="p">,</span> <span class="s2">&quot;-H&quot;</span><span class="p">],</span>
        <span class="s2">&quot;requeue_message&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;postsuper&quot;</span><span class="p">,</span> <span class="s2">&quot;-r&quot;</span><span class="p">],</span>
        <span class="s2">&quot;delete_message&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;postsuper&quot;</span><span class="p">,</span> <span class="s2">&quot;-d&quot;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>


<div class="viewcode-block" id="debug"><a class="viewcode-back" href="../index.html#pymailq.debug">[docs]</a><span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decorator to print some call informations and timing debug on stderr.</span>

<span class="sd">    Function&#39;s name, passed args and kwargs are printed to stderr. Elapsed time</span>
<span class="sd">    is also print at the end of call. This decorator is based on the value of</span>
<span class="sd">    :data:`DEBUG`. If ``True``, the debug informations will be displayed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">function</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Running </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[DEBUG]     args: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[DEBUG]   kwargs: </span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">DEBUG</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;[DEBUG] Exectime of </span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2"> seconds</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">return</span> <span class="n">run</span></div>


<div class="viewcode-block" id="load_config"><a class="viewcode-back" href="../index.html#pymailq.load_config">[docs]</a><span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load module configuration from .ini file</span>

<span class="sd">    Information from this file are directly used to override values stored in</span>
<span class="sd">    :attr:`pymailq.CONFIG`.</span>

<span class="sd">    Commands from configuration file are treated using :func:`shlex.split` to</span>
<span class="sd">    properly transform command string to list of arguments.</span>

<span class="sd">    :param str cfg_file: Configuration file</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :ref:`pymailq-configuration`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">CONFIG</span>

    <span class="n">cfg</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfg_file</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;core&quot;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="s2">&quot;postfix_spool&quot;</span><span class="p">):</span>
            <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;core&quot;</span><span class="p">][</span><span class="s2">&quot;postfix_spool&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;core&quot;</span><span class="p">,</span> <span class="s2">&quot;postfix_spool&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;commands&quot;</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">sections</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;use_sudo&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;yes&quot;</span><span class="p">:</span>
                    <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="s2">&quot;use_sudo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">command</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;commands&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                <span class="n">CONFIG</span><span class="p">[</span><span class="s2">&quot;commands&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">command</span></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2014, Denis &#39;jawa&#39; Pompilio.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>